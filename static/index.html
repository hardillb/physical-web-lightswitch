<html>
<head>
	<title>Light Switch</title>
	<link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
	<div id="controls">
		<div>
			<button id="on">On</button>
			<button id="off">Off</button>
		</div>
		<div>
			<label for="dim">Dimmer</label>
			<br />
			<input id="dim" type="range" min="0" max="255" value="255" />
		</div>
		<div>
			<label for="colour">Colour</label>
			<br />
			<input type="color" id="colour" value="#ffffff"/>
		</div>
		<div>
			<button id="ble" hidden="true">ble</button>
		</div>
	</div>
	<script type="text/javascript">

		var xhr = new XMLHttpRequest();
		xhr.onreadystatechange = function() {
			if (xhr.readyState == 4 && xhr.status == 200) {
				console.log("done");
			}
		}
		document.getElementById('on').onclick = function() {
			console.log("on");
			xhr.open("POST", "/toggle/on", true);
			xhr.send();
		};

		document.getElementById('off').onclick = function() {
			console.log("off");
			xhr.open("POST", "/toggle/off", true);
			xhr.send();
		};

		var dimmer = document.getElementById('dim');
		dimmer.onchange = function() {
			console.log(dimmer.value);
			xhr.open("POST", "/dim/" + dimmer.value, true);
			xhr.send();
		};

		var colour = document.getElementById('colour');
		colour.onchange = function() {
			console.log(colour.value);
			xhr.open("POST", "/rgb/" + colour.value.substring(1), true);
			xhr.send();
		};

		
		if (navigator.bluetooth) {
			var ble = document.getElementById("ble");
			ble.hidden = false;
			ble.onclick = function() {
				console.log("bluetooth found");
				navigator.bluetooth.requestDevice({
				  filters: [{
				    services: ['ba42561b-b1d2-440a-8d04-0cefb43faece']
				  }]
				})
				.then(device => {
					console.log(device.name);
					console.log(device.uuids);
					device.connectGATT();
				})
				.then(server => {
					return server.getPrimaryService('ba42561b-b1d2-440a-8d04-0cefb43faece');
				})
				.then(service => {
					service.getCharacteristic('6bcb06e2-7475-42a9-a62a-54a1f3ce11e6');
				})
				.then( characteristic => {
					//turn on
					var resetEnergyExpended = new Uint8Array([1]);
  					return characteristic.writeValue(resetEnergyExpended);
				})
				.catch(error => { 
					console.log("error:- " + error); 
				});
			}
		}
	</script>
</body>
</html>